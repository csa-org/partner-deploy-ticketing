---
sharedeks:
  description: |
    The `sharedeks` plan deploy a single EKS cluster into your AWS account and is inteded to be used by many apps.
    There are quite a few outputs that can be used from this deployment.

    outputs listing:

      * thing
      * thing
      * thing
      * thing
      * thing
      * thing
      * thing
  steps:
    - name: sharedeks
      extension: EKS
      description: This step uses the EKS extension (Terraform under the hood) to deploy the actual cluster. Expect runtimes in excess of 10 minutes
      args:
        region: us-east-2
        deployment_name: sharedeks
    - name: lacework
      extension: Kubectl
      description: This step deploys Lacework instrumentation to an existing K8s cluster
      tags: monitoring
      source:
        location: "https://raw.githubusercontent.com/lacework-dev/detc-resources/${GIT_BRANCH:-main}/apps/lacework/kube-manifest/lacework-all-k8s.yaml"
        templates:
          - "lacework-all-k8s.yaml"
      needs:
        - sharedeks
      helpers:
        - helper: WriteValue
          run_on_dryrun: true
          args:
            name: kubectl_config
            dstfile: kubectl
      lookup:
        control_plane_url: /sharedeks/outputs/cluster_endpoint
        kubectl_config: /sharedeks/outputs/kubectl_config
      args:
        lw_access_token: !secret lacework.access_token
        kubectl_config_file: kubectl
        kube_manifest_path: "lacework-all-k8s.yaml"
